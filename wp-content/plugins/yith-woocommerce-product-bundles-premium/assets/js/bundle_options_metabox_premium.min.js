jQuery(function(s){"use strict";var d=s("#_yith_wcpb_per_item_pricing"),n=s("#_yith_wcpb_non_bundled_shipping"),t=s("select#product-type"),o=s("#_yith_wcpb_bundle_regular_price"),a=s("#_yith_wcpb_bundle_sale_price"),e=s("#_yith_wcpb_show_saving_amount"),i=o.closest(".yith-wcpb-form-field"),c=a.closest(".yith-wcpb-form-field"),l=e.closest(".yith-wcpb-form-field"),_=woocommerce_admin_meta_boxes.post_id,r={message:null,overlayCSS:{background:"#fff",opacity:.7}},u=function(){return"yith_bundle"===t.val()},h={el:{root:s("#yith_bundle_product_data"),add_item_btn:s("#yith-wcpb-add-bundled-product"),bundled_items:s("#yith_bundle_product_data .yith-wcpb-bundled-items"),items_count:s("#yith_bundle_product_data .yith-wcpb-bundled-items .yith-wcpb-bundled-item").size()+1,ajax_filter_products:null,expandCollapse:s("#yith-wcpb-bundled-items-expand-collapse"),actions:s("#yith-wcpb-bundled-items__actions")},init:function(){this.el.add_item_btn.on("click",this.select_products),s(document).on("click",".yith-wcpb-add-product",this.add_item),s(document).on("keyup","input.yith-wcpb-select-product-box__filter__search",this.search_filter),s(document).on("click",".yith-wcpb-remove-bundled-product-item",this.remove_current_item),s(document).on("click",".yith-wcpb-bundled-item h3 a",this.stop_event_propagation),s(document).on("click",".yith-wcpb-select-product-box__products__pagination .first:not(.disabled)",this.paginate),s(document).on("click",".yith-wcpb-select-product-box__products__pagination .prev:not(.disabled)",this.paginate),s(document).on("click",".yith-wcpb-select-product-box__products__pagination .next:not(.disabled)",this.paginate),s(document).on("click",".yith-wcpb-select-product-box__products__pagination .last:not(.disabled)",this.paginate),this.sorting(),this.bundledItemsChangeHandler()},add_item:function(){var e=s(this).data("id"),t=s(this).closest(".yith-wcpb-select-product-box__products");if(e){t.block(r);var i={action:"yith_wcpb_add_product_in_bundle",open_closed:"open",bundle_id:_,id:h.el.items_count,product_id:e,security:yith_bundle_opts.nonces.addProductToBundle};s.ajax({type:"POST",url:ajaxurl,data:i,success:function(t){t.error?alert(t.error):t.html&&(h.el.bundled_items.append(t.html),s(document.body).trigger("wc-enhanced-select-init"),s(document.body).trigger("yith-plugin-fw-init-radio"),s(document).trigger("yith-wcpb-show-conditional-init"),h.el.items_count++,h.addItemToItemsWithQty(e),h.bundledItemsChangeHandler())},complete:function(){t.unblock()}})}},remove_current_item:function(){var t=s(this).closest(".yith-wcpb-bundled-item"),e=t.data("product-id");t.remove(),h.removeItemToItemsWithQty(e),h.bundledItemsChangeHandler()},filter_products:function(t){t.s!==undefined&&t.s.length<yith_bundle_opts.minimum_characters&&(t.s=""),t=s.extend(t,{action:"yith_wcpb_select_product_box_filtered"});var i=s(".yith-wcpb-select-product-box__products");i.block(r),h.el.ajax_filter_products&&h.el.ajax_filter_products.abort(),h.el.ajax_filter_products=s.ajax({type:"POST",url:ajaxurl,data:t,success:function(t){i.html(t),h.updateAddedQuantities()},complete:function(t,e){"abort"!==e&&i.unblock(r)}})},paginate:function(){var t=s(this).data("page");if(t!==undefined){var e=s("input.yith-wcpb-select-product-box__filter__search").val();h.filter_products({s:e,page:t})}},search_filter:function(){var t=s(this).val();(!t||t.length>=yith_bundle_opts.minimum_characters)&&h.filter_products({s:t})},select_products:function(){s.fn.yith_wcpb_popup({ajax:!0,url:ajaxurl,ajax_data:{action:"yith_wcpb_select_product_box"},ajax_success:function(){s(".yith-wcpb-select-product-box__filter__search").focus(),h.updateAddedQuantities()}})},sorting:function(){var t=this.el.bundled_items.find(".yith-wcpb-bundled-item").get();t.sort(function(t,e){var i=parseInt(s(t).attr("rel")),d=parseInt(s(e).attr("rel"));return i<d?-1:d<i?1:0}),s(t).each(function(t,e){h.el.bundled_items.append(e)}),this.el.bundled_items.sortable({items:".yith-wcpb-bundled-item",cursor:"move",axis:"y",handle:"h3",scrollSensitivity:40,forcePlaceholderSize:!0,opacity:.65,placeholder:"wc-metabox-sortable-placeholder",start:function(t,e){e.item.css("background-color","#f6f6f6")},stop:function(t,e){e.item.removeAttr("style")}})},stop_event_propagation:function(t){t.stopPropagation()},bundledItemsChangeHandler:function(){h.el.bundled_items.find(".yith-wcpb-bundled-item").length?(h.el.expandCollapse.show(),h.el.actions.removeClass("yith-wcpb-bundled-items__actions--hero")):(h.el.expandCollapse.hide(),h.el.actions.addClass("yith-wcpb-bundled-items__actions--hero")),h.updateAddedQuantities()},getItemsWithQty:function(){return h.el.root.data("items-with-qty")},setItemsWithQty:function(t){h.el.root.data("items-with-qty",t)},addItemToItemsWithQty:function(t){var e=h.getItemsWithQty();e[t]?e[t]++:e[t]=1,h.setItemsWithQty(e)},removeItemToItemsWithQty:function(t){var e=h.getItemsWithQty();e[t]?(e[t]--,e[t]||delete e[t]):e[t]=1,h.setItemsWithQty(e)},updateAddedQuantities:function(){var t=s(".yith-wcpb-select-product-box__products .yith-wcpb-select-product-box__product"),a=h.getItemsWithQty();t.each(function(t,e){var i=(e=s(e)).data("product-id"),d=a[i],n=e.find(".yith-wcpb-product-added"),o=n.find(".yith-wcpb-product-added__text");1===d?(o.html(yith_bundle_opts.i18n.addedLabelSingular),n.show()):1<d?(o.html(yith_bundle_opts.i18n.addedLabelPlural.replace("%s",d)),n.show()):n.hide()})}};h.init(),s(".pricing").addClass("hide_if_yith_bundle"),s("._manage_stock_field").addClass("show_if_yith_bundle"),s("._tax_status_field").closest("div").addClass("show_if_yith_bundle"),s("._sold_individually_field").addClass("show_if_yith_bundle").closest("div").addClass("show_if_yith_bundle"),s(".shipping_tab").addClass("yith_bundle_hide_if_non_bundled_shipping").addClass("yith_bundle_show_if_bundled_shipping");var p=function(){u()&&("yes"===d.val()?(i.hide(),c.hide(),l.hide(),s(".yith_bundle_hide_if_per_item_pricing").hide(),s(".yith_bundle_show_if_per_item_pricing").show()):(i.show(),c.show(),l.show(),s(".yith_bundle_show_if_fixed_pricing").show(),s(".yith_bundle_hide_if_fixed_pricing").hide()),"yes"===n.val()?s(".yith_bundle_hide_if_non_bundled_shipping").hide():s(".yith_bundle_show_if_bundled_shipping").show())};d.on("change",function(){u()&&"yes"===d.val()&&(o.val(""),a.val("")),p()}),n.on("change",p),p(),s("body").on("woocommerce-product-type-change",function(t,e,i){"yith_bundle"===e?(o.removeAttr("disabled"),a.removeAttr("disabled"),s("input#_downloadable").prop("checked",!1),s("input#_virtual").removeAttr("checked"),d.change(),n.change()):(o.attr("disabled","disabled"),a.attr("disabled","disabled"))}),t.change();var b={dom:{handler:s("#yith-wcpb-limit-product-selection"),fields:s("#_yith_wcpb_bundle_advanced_options_min, #_yith_wcpb_bundle_advanced_options_max, #_yith_wcpb_bundle_advanced_options_min_distinct, #_yith_wcpb_bundle_advanced_options_max_distinct"),fieldWrappers:!1},init:function(){var t=this;t.dom.fieldWrappers=t.dom.fields.closest(".yith-wcpb-form-field"),t.dom.handler.on("change",t.handleToggle),t.storeFieldValues(),t.handleVisibility()},storeFieldValues:function(){b.dom.fields.each(function(){s(this).data("prev-value",s(this).val())})},setFieldValues:function(t){b.dom.fields.each(function(){"prev"!==t?s(this).val(t):s(this).val(s(this).data("prev-value"))})},handleToggle:function(){"yes"===b.dom.handler.val()?b.setFieldValues("prev"):(b.storeFieldValues(),b.setFieldValues(0)),b.handleVisibility()},handleVisibility:function(){"yes"===b.dom.handler.val()?b.dom.fieldWrappers.show():b.dom.fieldWrappers.hide()}};b.init(),s(document).on("yith-wcpb-show-conditional-init",function(){s(".yith-wcpb-show-conditional:not(.yith-wcpb-show-conditional--initialized)").hide().each(function(){var t=s(this),e=t.data("field-id"),i=t.data("value"),l=t.data("rules")||[];if(t.addClass("yith-wcpb-show-conditional--initialized"),!l.length&&e&&i){var d={};d[e]=i,l=[d]}if(l.length){var n=function(){var t=!1;for(var e in l){var i=l[e],d=!0;for(var n in i){var o=s("#"+n),a=i[n],c=o.is("input[type=checkbox]")?o.is(":checked")?"yes":"no":o.val();if((a=a.split("|")).indexOf(c)<0){d=!1;break}}if(d){t=!0;break}}return t};for(var o in l){var a=l[o];for(var c in a){s("#"+c).on("change keyup",function(){n()?t.show():t.hide()}).trigger("change")}}}})}),s(document).trigger("yith-wcpb-show-conditional-init"),s(".yith-wcpb-reflection-field").each(function(){var t=s(this),e=s(t.data("original")),i=!1,d=!1;e.length&&(t.val(e.val()),t.on("change",function(){d||(i=!0,e.val(t.val()),e.trigger("change"),i=!1)}),e.on("change",function(){i||(d=!0,t.val(e.val()),t.trigger("change"),d=!1)}))})});